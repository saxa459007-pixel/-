<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Stats & Books</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        :root {
            --bg-color: #34383d;
            --card-bg: #3f444b;
            --nav-bg: #2b2e33;
            --text-main: #ffffff;
            --text-secondary: #b0b3b8;
            --accent: #5865F2;
            --input-bg: #4a5059;
            --separator-color: #4a5057;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø --- */
        .top-nav {
            width: 100%;
            max-width: 500px;
            height: 54px;
            background-color: var(--nav-bg);
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.2);
            box-sizing: border-box;
        }

        .nav-item {
            flex: 1;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s, color 0.2s;
            color: #72767d;
        }
        .nav-item:hover { background-color: rgba(255,255,255,0.05); color: var(--text-main); }
        .nav-item.active { color: var(--text-main); background-color: rgba(255,255,255,0.1); }
        .nav-icon { width: 26px; height: 26px; fill: currentColor; pointer-events: none; }

        /* --- –ö–û–ù–¢–ï–ù–¢ --- */
        .content-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; padding-bottom: 20px; box-sizing: border-box; }
        .page { display: none; width: 100%; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .profile-card { width: 100%; background-color: var(--card-bg); border-radius: 8px; margin-top: 15px; overflow: visible; box-shadow: 0 4px 6px rgba(0,0,0,0.1); box-sizing: border-box; position: relative; }
        .profile-header { padding: 15px; display: flex; align-items: flex-start; border-bottom: 1px solid var(--separator-color); position: relative; z-index: 10; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; object-fit: cover; border: 2px solid var(--separator-color); flex-shrink: 0; background-color: #000; }
        .info { flex: 1; overflow: visible; position: relative; }
        .player-name { font-size: 17px; margin: 0 0 5px 0; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main); }
        .user-id { font-size: 11px; color: var(--text-secondary); margin-bottom: 5px; }
        
        .class-wrapper { position: relative; width: 100%; z-index: 50; }
        .class-trigger { background: none; border: none; color: var(--text-secondary); font-size: 12px; padding: 4px 8px; margin: 0; cursor: pointer; text-transform: lowercase; font-family: inherit; display: inline-flex; align-items: center; gap: 4px; outline: none; text-align: left; border-radius: 4px; transition: background 0.2s; width: auto; }
        .class-trigger:hover { background-color: rgba(255,255,255,0.05); color: var(--text-main); }
        .class-trigger::after { content: '‚ñº'; font-size: 8px; transition: transform 0.2s; display: inline-block; }
        .class-trigger.open::after { transform: rotate(180deg); }
        
        .class-list { 
            display: none; 
            position: absolute; 
            top: 100%; 
            left: 0; 
            margin-top: 5px; 
            background-color: var(--input-bg); 
            border-radius: 4px; 
            overflow: hidden; 
            width: 100%; 
            max-height: 200px; 
            overflow-y: auto; 
            border: 1px solid var(--separator-color); 
            box-shadow: 0 8px 24px rgba(0,0,0,0.6); 
            z-index: 1000; 
        }
        .class-list.show { display: block; animation: fadeIn 0.2s; }
        
        .class-item { padding: 10px 12px; font-size: 13px; color: var(--text-main); text-transform: lowercase; cursor: pointer; border-bottom: 1px solid var(--separator-color); transition: background 0.1s; user-select: none; }
        .class-item:last-child { border-bottom: none; }
        .class-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .class-item.active { color: var(--accent); font-weight: 600; background-color: rgba(88, 101, 242, 0.15); }

        .stats-grid { width: 100%; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 15px; box-sizing: border-box; }
        .stat-cell { background-color: transparent; border: none; border-radius: 0; padding: 8px 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .stat-cell:active, .stat-cell:hover { background-color: transparent; }
        .stat-row { display: flex; align-items: center; gap: 6px; pointer-events: none; width: 100%; justify-content: center; }
        .stat-icon { font-size: 18px; line-height: 1; flex-shrink: 0; text-align: center; width: 20px; }
        .stat-value-container { position: relative; min-width: 34px; display: flex; justify-content: center; align-items: center; }
        .stat-value { font-size: 14px; font-weight: 700; color: var(--text-main); padding: 0 2px; text-align: center; white-space: nowrap; line-height: 1.4; }
        .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: lowercase; flex-shrink: 0; }
        .stat-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--input-bg); border: 1px solid var(--accent); color: white; font-size: 14px; font-weight: 700; font-family: inherit; padding: 0; margin: 0; border-radius: 0; outline: none; text-align: center; line-height: 1.4; z-index: 20; box-sizing: border-box; appearance: none; -webkit-appearance: none; }
        .stat-input::-webkit-outer-spin-button, .stat-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .stat-input[type=number] { -moz-appearance: textfield; }

        .class-result-box { width: 100%; padding: 0 15px; box-sizing: border-box; margin-bottom: 15px; }
        .result-card { background-color: transparent; border: none; border-radius: 0; padding: 12px 0 10px 0; display: flex; align-items: center; box-shadow: none; border-top: 1px solid var(--separator-color); margin-top: 5px; }
        .result-description { font-size: 13px; color: var(--text-secondary); line-height: 1.4; width: 100%; }
        .highlight-class { color: var(--text-main); font-weight: 700; font-size: 13px; margin-right: 4px; }
        .highlight-val { color: var(--text-secondary); font-weight: 600; }

        .books-list { width: 100%; padding: 15px; box-sizing: border-box; }
        .book-item { background-color: var(--card-bg); border-radius: 8px; padding: 12px 15px; margin-bottom: 10px; border: 1px solid var(--separator-color); display: flex; flex-direction: column; gap: 8px; }
        .book-header { display: flex; justify-content: space-between; align-items: center; }
        .book-name { font-size: 14px; font-weight: 700; color: var(--text-main); text-transform: lowercase; }
        .book-level-control { display: flex; align-items: center; gap: 8px; }
        .book-level-control label { font-size: 11px; color: var(--text-secondary); text-transform: lowercase; }
        .book-level-input { background: var(--input-bg); border: 1px solid var(--accent); color: white; font-size: 13px; font-weight: 700; padding: 2px 6px; border-radius: 4px; width: 50px; text-align: center; outline: none; }
        .book-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.4; white-space: pre-line; }
        .book-val { color: var(--text-main); font-weight: 600; }

        .controls { width: 100%; padding: 0 15px 15px 15px; box-sizing: border-box; }
        .btn-reset { width: 100%; padding: 10px; background: transparent; color: #72767d; border: 1px solid #42454a; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 8px; text-align: center; transition: all 0.2s; }
        .btn-reset:hover { background-color: rgba(255,255,255,0.05); color: var(--text-main); }
        .btn-reset:active { opacity: 0.6; }
        .btn-reset.danger { color: #ed4245; border-color: #ed4245; }
        .btn-reset.danger:hover { background-color: rgba(237, 66, 69, 0.1); }
    </style>
</head>
<body>

    <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <div class="top-nav">
        <div class="nav-item active" onclick="switchPage('profile')" id="nav-profile">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        </div>
        <div class="nav-item" onclick="switchPage('books')" id="nav-books">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
        </div>
        <div class="nav-item" title="–ï–ª–∫–∞">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M2 18h20L12 6L2 18z" /><path d="M4 13h16L12 3L4 13z" fill-opacity="0.9" /><path d="M6 9h12L12 2L6 9z" fill-opacity="0.8" /><path d="M10.5 18h3v3h-3z" fill-opacity="0.6" /></svg>
        </div>
    </div>

    <div class="content-container">
        
        <!-- –°–¢–†–ê–ù–ò–¶–ê –ü–†–û–§–ò–õ–Ø -->
        <div id="page-profile" class="page active">
            <div class="profile-card">
                <div class="profile-header">
                    <img src="https://via.placeholder.com/50" alt="Avatar" class="avatar" id="user-avatar">
                    <div class="info">
                        <h1 class="player-name" id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                        <div class="user-id" id="user-id"></div>
                        <div class="class-wrapper">
                            <button class="class-trigger" id="classTrigger" onclick="toggleClassList()">–∂–Ω–µ—Ü –¥—É—à</button>
                            <div class="class-list" id="classList"></div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <!-- –†—è–¥ 1 -->
                    <div class="stat-cell" onclick="editStatByCell(this)"><div class="stat-row"><span class="stat-icon">üïØÔ∏è</span><div class="stat-value-container"><span class="stat-value" data-key="lvl">207</span></div><span class="stat-label">—É—Ä</span></div></div>
                    <div class="stat-cell" onclick="editStatByCell(this)"><div class="stat-row"><span class="stat-icon">‚öîÔ∏è</span><div class="stat-value-container"><span class="stat-value" data-key="atk">717</span></div><span class="stat-label">–∞—Ç–∫</span></div></div>
                    <div class="stat-cell" onclick="editStatByCell(this)"><div class="stat-row"><span class="stat-icon">üõ°Ô∏è</span><div class="stat-value-container"><span class="stat-value" data-key="armor">212</span></div><span class="stat-label">–±—Ä–Ω</span></div></div>
                    <!-- –†—è–¥ 2 -->
                    <div class="stat-cell" onclick="editStatByCell(this)"><div class="stat-row"><span class="stat-icon">üí™</span><div class="stat-value-container"><span class="stat-value" data-key="str">403</span></div><span class="stat-label">—Å–∏–ª</span></div></div>
                    <div class="stat-cell" onclick="editStatByCell(this)"><div class="stat-row"><span class="stat-icon">üëê</span><div class="stat-value-container"><span class="stat-value" data-key="agi">861</span></div><span class="stat-label">–ª–≤–∫</span></div></div>
                    <div class="stat-cell" onclick="editStatByCell(this)"><div class="stat-row"><span class="stat-icon">‚ù§Ô∏è</span><div class="stat-value-container"><span class="stat-value" data-key="vit">602</span></div><span class="stat-label">–≤–Ω—Å</span></div></div>
                    <!-- –†—è–¥ 3 -->
                    <div class="stat-cell" onclick="editStatByCell(this)"><div class="stat-row"><span class="stat-icon">üçÄ</span><div class="stat-value-container"><span class="stat-value" data-key="luck">57</span></div><span class="stat-label">—É–¥—á</span></div></div>
                    <div class="stat-cell" onclick="editStatByCell(this)"><div class="stat-row"><span class="stat-icon">üéØ</span><div class="stat-value-container"><span class="stat-value" data-key="acc">112</span></div><span class="stat-label">—Ç—á–Ω</span></div></div>
                    <div class="stat-cell" onclick="editStatByCell(this)"><div class="stat-row"><span class="stat-icon">üåÄ</span><div class="stat-value-container"><span class="stat-value" data-key="conc">64</span></div><span class="stat-label">–∫—Ü</span></div></div>
                    <!-- –†—è–¥ 4 -->
                    <div class="stat-cell" onclick="editStatByCell(this)"><div class="stat-row"><span class="stat-icon">üìú</span><div class="stat-value-container"><span class="stat-value" data-key="class_lvl">50</span></div><span class="stat-label">—É—Ä. –∫–ª.</span></div></div>
                    <div class="stat-cell" onclick="editStatByCell(this, true)"><div class="stat-row"><span class="stat-icon">üî∞</span><div class="stat-value-container"><span class="stat-value" data-key="resist">0%</span></div><span class="stat-label">—Å–æ–ø—Ä–∞</span></div></div>
                    <div class="stat-cell" onclick="editStatByCell(this, false, true)"><div class="stat-row"><span class="stat-icon" id="karma-icon">üòê</span><div class="stat-value-container"><span class="stat-value" data-key="karma">0</span></div><span class="stat-label">–∫–∞—Ä–º–∞</span></div></div>
                </div>

                <div class="class-result-box">
                    <div class="result-card">
                        <div class="result-description" id="res-class-desc"></div>
                    </div>
                </div>
            </div>
            <div class="controls"><button class="btn-reset danger" onclick="clearAll()">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë –≤—Ä—É—á–Ω—É—é</button></div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê –ö–ù–ò–ì -->
        <div id="page-books" class="page">
            <div class="books-list" id="booksContainer"></div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã –ø–∞—Å—Å–∏–≤–æ–∫ -->
    <script src="passives.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ–æ—Ä–º—É–ª—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö —É–º–µ–Ω–∏–π -->
    <script src="actives.js"></script>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ -->
    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ö–õ–ê–°–°–û–í ---
        const CLASS_CONFIG = {
            "–∂–Ω–µ—Ü –¥—É—à": { type: "warlock", name: "–ß–µ—Ä–Ω–æ–∫–Ω–∏–∂–Ω–∏–∫", desc: "<span class='highlight-class'>–ß–µ—Ä–Ω–æ–∫–Ω–∏–∂–Ω–∏–∫</span>: –î–æ–ø. —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –Ω–∞ <span class='highlight-val'>{val}%</span>" },
            "–ø–æ–≤–µ–ª–∏—Ç–µ–ª—å –º—Ä–∞–∫–∞": { type: "warlock", name: "–ß–µ—Ä–Ω–æ–∫–Ω–∏–∂–Ω–∏–∫", desc: "<span class='highlight-class'>–ß–µ—Ä–Ω–æ–∫–Ω–∏–∂–Ω–∏–∫</span>: –î–æ–ø. —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –Ω–∞ <span class='highlight-val'>{val}%</span>" },
            "–æ—Ç—Ä–µ–∫—à–∏–π—Å—è": { type: "vampire", name: "–ö—Ä–æ–≤–æ–ø–∏–π—Ü–∞", desc: "<span class='highlight-class'>–ö—Ä–æ–≤–æ–ø–∏–π—Ü–∞</span>: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –≤ —Ä–∞–∑–º–µ—Ä–µ <span class='highlight-val'>{val}%</span> –æ—Ç —É—Ä–æ–Ω–∞ –ø—Ä–æ—Å—Ç—ã–º–∏ –∞—Ç–∞–∫–∞–º–∏" },
            "–ø—Ä–æ–∫–∞–∂–µ–Ω–Ω—ã–π": { type: "vampire", name: "–ö—Ä–æ–≤–æ–ø–∏–π—Ü–∞", desc: "<span class='highlight-class'>–ö—Ä–æ–≤–æ–ø–∏–π—Ü–∞</span>: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –≤ —Ä–∞–∑–º–µ—Ä–µ <span class='highlight-val'>{val}%</span> –æ—Ç —É—Ä–æ–Ω–∞ –ø—Ä–æ—Å—Ç—ã–º–∏ –∞—Ç–∞–∫–∞–º–∏" },
            "–∫—Ä–µ—Å—Ç–æ–Ω–æ—Å–µ—Ü": { type: "paladin", name: "–ü–∞–ª–∞–¥–∏–Ω", desc: "<span class='highlight-class'>–ü–∞–ª–∞–¥–∏–Ω</span>: –®–∞–Ω—Å <span class='highlight-val'>{val}%</span>, —á—Ç–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —É—Ä–æ–Ω –æ—Ç –æ–±—ã—á–Ω–æ–π –∞—Ç–∞–∫–∏ –æ—Ç—Ä–∞–∑–∏—Ç—Å—è –≤ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ (–Ω–µ –¥–æ–±–∏–≤–∞–µ—Ç –≤ PvP)" },
            "–≤–æ–ø–ª–æ—â–µ–Ω–∏–µ —Å–≤–µ—Ç–∞": { type: "paladin", name: "–ü–∞–ª–∞–¥–∏–Ω", desc: "<span class='highlight-class'>–ü–∞–ª–∞–¥–∏–Ω</span>: –®–∞–Ω—Å <span class='highlight-val'>{val}%</span>, —á—Ç–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —É—Ä–æ–Ω –æ—Ç –æ–±—ã—á–Ω–æ–π –∞—Ç–∞–∫–∏ –æ—Ç—Ä–∞–∑–∏—Ç—Å—è –≤ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ (–Ω–µ –¥–æ–±–∏–≤–∞–µ—Ç –≤ PvP)" },
            "–∫–ª–∏–Ω–æ–∫ —Ç—å–º—ã": { type: "assassin", name: "–ê—Å—Å–∞—Å–∏–Ω", desc: "<span class='highlight-class'>–ê—Å—Å–∞—Å–∏–Ω</span>: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ <span class='highlight-val'>{val}%</span> —à–∞–Ω—Å–∞ —É–∫–ª–æ–Ω–∏—Ç—å—Å—è –æ—Ç –∞—Ç–∞–∫–∏" },
            "–∫–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π —É–±–∏–π—Ü–∞": { type: "assassin", name: "–ê—Å—Å–∞—Å–∏–Ω", desc: "<span class='highlight-class'>–ê—Å—Å–∞—Å–∏–Ω</span>: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ <span class='highlight-val'>{val}%</span> —à–∞–Ω—Å–∞ —É–∫–ª–æ–Ω–∏—Ç—å—Å—è –æ—Ç –∞—Ç–∞–∫–∏" },
            "–±–µ—Ä—Å–µ—Ä–∫–µ—Ä": { type: "executioner", name: "–ü–∞–ª–∞—á", desc: "<span class='highlight-class'>–ü–∞–ª–∞—á</span>: –ï—Å–ª–∏ —É –≤—Ä–∞–≥–∞ < {val}% –ù–† ‚Äî 50% —à–∞–Ω—Å –∫–∞–∑–Ω–∏ –±–µ–∑ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è" },
            "–ø–æ—Ç—Ä–æ—à–∏—Ç–µ–ª—å": { type: "executioner", name: "–ü–∞–ª–∞—á", desc: "<span class='highlight-class'>–ü–∞–ª–∞—á</span>: –ï—Å–ª–∏ —É –≤—Ä–∞–≥–∞ < {val}% –ù–† ‚Äî 50% —à–∞–Ω—Å –∫–∞–∑–Ω–∏ –±–µ–∑ –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è" },
            "–∞–ø–æ—Å—Ç–æ–ª": { type: "secret_keeper", name: "–•—Ä–∞–Ω–∏—Ç–µ–ª—å —Ç–∞–π–Ω", desc: "<span class='highlight-class'>–•—Ä–∞–Ω–∏—Ç–µ–ª—å —Ç–∞–π–Ω</span>: –®–∞–Ω—Å {val}% –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —É–º–µ–Ω–∏—è (-30% –ø—Ä–∏ –¥–æ–ø. –¥–µ–π—Å—Ç–≤–∏–∏)" },
            "–≤–µ—Ä—Ö–æ–≤–Ω—ã–π –º–∞–≥": { type: "secret_keeper", name: "–•—Ä–∞–Ω–∏—Ç–µ–ª—å —Ç–∞–π–Ω", desc: "<span class='highlight-class'>–•—Ä–∞–Ω–∏—Ç–µ–ª—å —Ç–∞–π–Ω</span>: –®–∞–Ω—Å {val}% –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —É–º–µ–Ω–∏—è (-30% –ø—Ä–∏ –¥–æ–ø. –¥–µ–π—Å—Ç–≤–∏–∏)" }
        };

        // –ö–ª—é—á–∏ –¥–ª—è localStorage
        const DB_KEY = 'rpg_stats_final_verified_v8';
        const DATE_KEY = 'rpg_date_final_verified_v8';
        const CLASS_KEY = 'rpg_class_final_verified_v8';
        const BOOKS_LVL_KEY = 'rpg_books_levels_final_verified_v8';

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const triggerBtn = document.getElementById('classTrigger');
        const listDiv = document.getElementById('classList');
        const karmaIconSpan = document.getElementById('karma-icon');

        // --- –õ–û–ì–ò–ö–ê –ö–ê–†–ú–´ ---
        function getKarmaIcon(value) {
            const num = parseInt(value);
            if (num < 0) return 'üòà';
            if (num === 0) return 'üòê';
            return 'üòá';
        }
        
        function updateKarmaIcon() {
            const karmaVal = document.querySelector('.stat-value[data-key="karma"]');
            if (karmaVal) {
                const val = parseInt(karmaVal.textContent) || 0;
                let displayVal = val;
                if (displayVal < -20) displayVal = -20;
                if (displayVal > 20) displayVal = 20;
                karmaIconSpan.textContent = getKarmaIcon(displayVal);
                if (val !== displayVal) karmaVal.textContent = displayVal;
            }
        }

        // --- –§–û–†–ú–£–õ–´ –ö–õ–ê–°–°–ê ---
        function calculateRunesResist(runesCount) {
            if (runesCount < 0) runesCount = 0;
            if (runesCount === 0) return 0;
            let resist = 10.0 * Math.pow(runesCount, 0.25);
            return Math.floor(resist);
        }

        function calculateClassEffect(type, level) {
            if (level < 1) level = 1;
            let coefficient = 5.0;
            let maxCap = 30.0;
            if (type === 'warlock' || type === 'vampire') {
                coefficient = 10.0;
                maxCap = 50.0;
            }
            let effect = coefficient * Math.sqrt(level / 1000.0) + 10.0;
            effect = Math.floor(effect * 10) / 10;
            return Math.min(maxCap, effect);
        }

        function updateClassResult() {
            const className = triggerBtn.textContent.trim();
            const classLvlInput = document.querySelector('.stat-value[data-key="class_lvl"]').textContent;
            const classLvl = parseInt(classLvlInput) || 1;
            const config = CLASS_CONFIG[className];
            
            if (!config) {
                document.getElementById('res-class-desc').innerHTML = "–ö–ª–∞—Å—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";
                return;
            }

            const bonus = calculateClassEffect(config.type, classLvl);
            document.getElementById('res-class-desc').innerHTML = config.desc.replace('{val}', bonus.toFixed(1));
        }

        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–ü–ò–°–ö–ê –ö–õ–ê–°–°–û–í ---
        window.toggleClassList = function() {
            const isShown = listDiv.classList.contains('show');
            if (isShown) {
                listDiv.classList.remove('show');
                triggerBtn.classList.remove('open');
            } else {
                listDiv.classList.add('show');
                triggerBtn.classList.add('open');
            }
        };

        window.selectClass = function(cls) {
            localStorage.setItem(CLASS_KEY, cls);
            localStorage.setItem(DATE_KEY, Date.now().toString());
            triggerBtn.textContent = cls;
            
            const items = listDiv.querySelectorAll('.class-item');
            items.forEach(item => {
                item.classList.toggle('active', item.textContent === cls);
            });

            listDiv.classList.remove('show');
            triggerBtn.classList.remove('open');
            
            updateClassResult();
        };

        function initClassList() {
            const saved = localStorage.getItem(CLASS_KEY) || "–∂–Ω–µ—Ü –¥—É—à";
            triggerBtn.textContent = saved;
            listDiv.innerHTML = '';

            Object.keys(CLASS_CONFIG).forEach(cls => {
                const div = document.createElement('div');
                div.className = 'class-item';
                if (cls === saved) div.classList.add('active');
                div.textContent = cls;
                
                div.onclick = function(e) {
                    e.stopPropagation();
                    selectClass(cls);
                };
                
                listDiv.appendChild(div);
            });
            
            updateClassResult();
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(e) {
            if (!listDiv.contains(e.target) && e.target !== triggerBtn) {
                listDiv.classList.remove('show');
                triggerBtn.classList.remove('open');
            }
        });

        // --- –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø VK ---
        async function loadVKUserData() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const user = await vkBridge.send('VKWebAppGetUserInfo');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
                const avatar = document.getElementById('user-avatar');
                if (user.photo_200) {
                    avatar.src = user.photo_200;
                } else if (user.photo_100) {
                    avatar.src = user.photo_100;
                } else if (user.photo_50) {
                    avatar.src = user.photo_50;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è
                const nameElement = document.getElementById('user-name');
                nameElement.textContent = `${user.first_name} ${user.last_name}`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º ID
                const idElement = document.getElementById('user-id');
                idElement.textContent = `ID: ${user.id}`;
                
            } catch (error) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è VK', error);
                // –ï—Å–ª–∏ –Ω–µ –≤ VK, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
                document.getElementById('user-name').textContent = '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø ---
        function formatNumber(num, format) {
            if (format === ':.2f') return num.toFixed(2);
            return Math.floor(num);
        }

        // --- –†–ï–ù–î–ï–†–ò–ù–ì –ö–ù–ò–ì ---
        function renderBooks() {
            const savedLevels = JSON.parse(localStorage.getItem(BOOKS_LVL_KEY) || '{}');
            const container = document.getElementById('booksContainer');
            container.innerHTML = '';
            
            for (const [name, data] of Object.entries(PASSIVE_SKILLS)) {
                const lvl = savedLevels[name] || 1;
                let result = data.calc(lvl);
                let desc = data.desc;
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ displayDivide
                if (data.displayDivide && typeof result === 'number') { 
                    result = result / 100; 
                } else if (data.displayDivide && typeof result === 'object') { 
                    for (let k in result) { 
                        if (typeof result[k] === 'number') { 
                            result[k] = result[k] / 100; 
                        }
                    } 
                }
                
                // –ó–∞–º–µ–Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
                if (typeof result === 'object') {
                    for (const [key, val] of Object.entries(result)) {
                        const regex = new RegExp(`\\{${key}(?::\\.2f)?\\}`, 'g');
                        const isFloat = data.desc.includes(`${key}:.2f`);
                        desc = desc.replace(regex, `<span class="book-val">${formatNumber(val, isFloat ? ':.2f' : '')}</span>`);
                    }
                } else {
                    const isFloat = desc.includes('result:.2f');
                    desc = desc.replace(/\{result(?::\.2f)?\}/g, `<span class="book-val">${formatNumber(result, isFloat ? ':.2f' : '')}</span>`);
                }
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è {result_div}
                if (desc.includes('{result_div}') && !data.displayDivide) {
                    const finalDiv = (result / 100).toFixed(2);
                    desc = desc.replace('{result_div}', `<span class="book-val">${finalDiv}</span>`);
                }
                
                const item = document.createElement('div');
                item.className = 'book-item';
                item.innerHTML = `
                    <div class="book-header">
                        <div class="book-name">${name}</div>
                        <div class="book-level-control">
                            <label>—É—Ä:</label>
                            <input type="number" class="book-level-input" value="${lvl}" onchange="updateBookLevel('${name}', this.value)" min="1">
                        </div>
                    </div>
                    <div class="book-desc">${desc}</div>
                `;
                container.appendChild(item);
            }
        }

        window.updateBookLevel = function(name, value) {
            const savedLevels = JSON.parse(localStorage.getItem(BOOKS_LVL_KEY) || '{}');
            savedLevels[name] = parseInt(value) || 1;
            localStorage.setItem(BOOKS_LVL_KEY, JSON.stringify(savedLevels));
            renderBooks();
        };

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        window.switchPage = function(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.getElementById(`nav-${pageName}`).classList.add('active');
            if (pageName === 'books') renderBooks();
        };

        // --- –†–ê–ë–û–¢–ê –° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú ---
        function checkReset() {
            const last = localStorage.getItem(DATE_KEY);
            if (last && (Date.now() - parseInt(last) > 7 * 24 * 60 * 60 * 1000)) clearAll();
        }

        function saveStats() {
            const data = {};
            document.querySelectorAll('.stat-value').forEach(el => data[el.dataset.key] = el.textContent);
            localStorage.setItem(DB_KEY, JSON.stringify(data));
            localStorage.setItem(DATE_KEY, Date.now().toString());
            updateClassResult();
            updateKarmaIcon();
        }

        function loadStats() {
            const raw = localStorage.getItem(DB_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);
            document.querySelectorAll('.stat-value').forEach(el => {
                if (data[el.dataset.key]) el.textContent = data[el.dataset.key];
            });
            updateClassResult();
            updateKarmaIcon();
        }

        window.clearAll = function() {
            if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã.')) {
                localStorage.removeItem(DB_KEY);
                localStorage.removeItem(DATE_KEY);
                localStorage.removeItem(CLASS_KEY);
                localStorage.removeItem(BOOKS_LVL_KEY);
                location.reload();
            }
        }

        // --- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–¢–ê–¢–û–í ---
        window.editStatByCell = function(cellElement, isResist = false, isKarma = false) {
            const valueContainer = cellElement.querySelector('.stat-value-container');
            const valueSpan = valueContainer.querySelector('.stat-value');
            let currentVal = valueSpan.textContent;
            const key = valueSpan.dataset.key;
            let cleanVal = currentVal;
            if (isResist) cleanVal = currentVal.replace('%', '');
            
            const input = document.createElement('input');
            input.type = 'number';
            input.value = cleanVal === '0' ? '' : cleanVal;
            input.className = 'stat-input';
            valueSpan.style.visibility = 'hidden'; 
            valueContainer.appendChild(input);
            input.focus();
            input.select();
            
            const finish = () => {
                let newVal = input.value;
                if (newVal === '') newVal = '0';
                let finalValue = newVal;
                
                if (isResist) {
                    const runes = parseFloat(newVal);
                    const percent = calculateRunesResist(runes);
                    finalValue = percent + '%';
                } else if (isKarma) {
                    let num = parseInt(newVal);
                    if (num < -20) num = -20;
                    if (num > 20) num = 20;
                    finalValue = num.toString();
                } else {
                    const num = parseFloat(newVal);
                    if (!isNaN(num)) finalValue = Math.floor(num).toString();
                    if (key === 'class_lvl' && parseInt(finalValue) < 1) finalValue = '1';
                }
                
                valueSpan.textContent = finalValue;
                valueSpan.style.visibility = 'visible';
                input.remove();
                if (isKarma) updateKarmaIcon();
                saveStats();
            };
            
            input.onblur = finish;
            input.onkeydown = e => { if(e.key === 'Enter') input.blur(); };
            input.onclick = e => e.stopPropagation();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å VK Bridge
        window.onload = () => {
            checkReset();
            loadStats();
            initClassList();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK Bridge –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try {
                vkBridge.send('VKWebAppInit')
                    .then(() => {
                        console.log('VK Bridge –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
                        loadVKUserData();
                    })
                    .catch(error => {
                        console.log('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ VK Bridge:', error);
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                        document.getElementById('user-name').textContent = '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    });
            } catch (e) {
                console.log('VK Bridge –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, –∑–∞–ø—É—Å–∫ –≤–Ω–µ VK)');
                document.getElementById('user-name').textContent = '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            }
        };
    </script>
</body>
</html>
